<div class="header">
  <div>
    <b>Timesaver:</b>
    Conditionally select, rename, export, delete or duplicate anything from the canvas.
  </div>
  <div class="header-buttons">
    <button id="refresh" class="button">Refresh</button>
    <button id="reset" class="button">Reset filters</button>
    <button id="csv" class="button">Export list as CSV</button>
  </div>
</div>
</br>
<div class="main-container">
  <div class="left-panel">
    <div class="selector">
      <p>
        Find all
        <select id="elementType">
          <option value="ANY">objects</option>
          <!-- <option value="VARIABLE">variables</option>
            <option value="STYLE">styles</option> -->
          <option value="UNION">unions</option>
          <option value="SUBTRACT">subtracts</option>
          <option value="INTERSECT">intersects</option>
          <option value="EXCLUDE">excludes</option>
          <option value="COMPONENT">components</option>
          <option value="ELLIPSE">ellipses</option>
          <option value="FRAME">frames</option>
          <option value="GROUP">groups</option>
          <option value="INSTANCE">instances</option>
          <option value="LINE">lines</option>
          <option value="POLYGON">polygons</option>
          <option value="RECTANGLE">rectangles</option>
          <option value="SECTION">sections</option>
          <option value="STAR">stars</option>
          <option value="TEXT">texts</option>
          <option value="VECTOR">vectors</option>
        </select>
      </p>
      </br>
      <p>
        in the
        <select id="objectScope">
          <option value="current-page">current page</option>
          <option value="all-pages">whole document</option>
          <option value="current-selection">current selection</option>
        </select>
      </p>
    </div>
    </br>

    <div id="filterContainer"></div>

    <button id="addFilter">+ Add filter condition</button>
    </br>
  </br>
    <div id="loadingMessage" style="display: block; text-align: left; font-weight: bold; color: red;">
      Loading, please wait...
    </div>
  </br>
    <p id="elementCount" style="margin-top: 10px; font-weight: bold;">0 element(s) found</p>
    <div class="actions">
      <label>
        <input type="radio" name="action" value="select" checked> Select
      </label>
      <label>
        <input type="radio" name="action" value="delete"> Delete
      </label>
      <label>
        <input type="radio" name="action" value="duplicate"> Duplicate
      </label>
      <label>
        <input type="radio" name="action" value="rename"> Rename
      </label>
      <label>
        <input type="radio" name="action" value="export"> Export
      </label>
    </div>
    <div id="exportOptions" style="display: none;">
      <label>
        Scale
        <select id="exportScale">
          <option value="default" selected>default</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </label>
      <label>
        Format
        <select id="exportFormat">
          <option value="default" selected>default</option>
          <option value="PNG">PNG</option>
          <option value="JPG">JPG</option>
        </select>
      </label>
      <label>
        Suffix
        <input type="text" id="exportSuffix" value="default" />
      </label>
    </div>
    <input type="text" id="replaceText" placeholder="Text to replace" style="display: none;">
    <input type="text" id="newName" placeholder="New name. Try {id}, {name}, {page}, {date} or {alphabet}" style="display: none; width: 350px;">
    <button id="execute">Execute</button>
  </div>

  <div id="resultsContainer" class="results">
    <table id="resultsTable">
      <thead>
        <tr id="resultsTableHeader">
          <th><input type="checkbox" id="selectAllCheckbox"></th>
          <th>ID</th>
          <th>Layer Name</th>
          <th>Page</th>
          <th id="newNameHeader" style="display: none;">New Name</th>
        </tr>
      </thead>
      <tbody id="resultsList"></tbody>
    </table>
    
  </div>
</div>

<style>
  body {
    font-family: 'Tahoma', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-y: hidden;
  }

  .select-checkbox,
  #selectAllCheckbox {
    cursor: pointer;
    width: 12px;
    height: 12px;
    transform: scale(1.5);
  }

  body {
    font-size: 15px;
  }

  th:first-child,
  td:first-child {
    width: 12px;
  }

  .header {
    display: flex;
    padding: 10;
    justify-content: space-between;
    align-items: center;
    background-color: #d4d4d4;
    padding-bottom: 10px;
  }

  .button {
    background-color: #007bff;
  }

  .button:hover {
    background-color: #0056b3;
  }

  .main-container {
    margin: 0px 10px;
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex: 1;
    overflow: hidden;
  }

  .left-panel {
    flex: 2.5;
    overflow-y: auto;
  }

  .selector {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .header-buttons {
    display: flex;
    gap: 10px;
  }

  p {
    margin: 0px 0;
  }

  th {
    color: black;
    cursor: default;
  }

  select,
  input[type="text"],
  input[type="number"],
  button {
    padding: 5px;
    margin: 5px 0;
  }

  select,
  input[type="text"],
  input[type="number"] {
    width: 120px;
  }

  #objectScope {
    width: 150px; 
  }

  button {
    background-color: #096e47;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 8px 8px;
  }

  button:hover {
    background-color: #075235;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  #filterContainer {
    margin-top: 0px;
  }

  #addFilter {
    background-color: #007bff;
    padding: 8px 15px;
  }

  #addFilter:hover {
    background-color: #0056b3;
    padding: 8px 15px;
  }

  .filterRow {
    display: flex;
    align-items: center;
    padding: 5px;
    margin-bottom: 5px;
    background-color: #e3ecff;
  }

  .filterRow label {
    margin-right: 5px;
  }

  .filterRow select,
  .filterRow input[type="text"] {
    margin-right: 10px;
  }

  .removeFilter {
    background-color: #dc3545;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
  }

  .removeFilter:hover {
    background-color: #c82333;
  }

  .actions {
    display: flex;
    align-items: center;
    gap: 10px;
    bottom: 0;
    background-color: white;
    padding: 10px 0;
  }

  .results {
    flex: 2;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 5px 2px;
    border-radius: 4px;
  }

  .results table {
    width: 100%;
    border-collapse: collapse;
    cursor: pointer;
  }

  .results th,
  .results td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  .results tr:hover {
    background-color: #f0f0f0;
  }
</style>

<script>
  let elements = [];
  let selectedElements = new Set();

  const updateResultsList = (elements) => {
    const resultsList = document.getElementById('resultsList');
    resultsList.innerHTML = '';
    const isRename = document.querySelector('input[name="action"]:checked').value === 'rename';
    const newNameTemplate = document.getElementById('newName').value || '{name}';
    const replaceText = document.getElementById('replaceText').value;
    const elementType = document.getElementById('elementType').value;

    const resultsTableHeader = document.getElementById('resultsTableHeader');
    if (elementType === 'VARIABLE') {
      resultsTableHeader.innerHTML = `
        <th><input type="checkbox" id="selectAllCheckbox" checked></th>
        <th>ID</th>
        <th>Collection Name</th>
        <th>Mode Name</th>
        <th>Variable Name</th>
        <th>Variable Value</th>
      `;
    } else if (elementType === 'STYLE') {
      resultsTableHeader.innerHTML = `
        <th><input type="checkbox" id="selectAllCheckbox" checked></th>
        <th>ID</th>
        <th>Style Name</th>
        <th>Style Type</th>
      `;
    } else {
      resultsTableHeader.innerHTML = `
        <th><input type="checkbox" id="selectAllCheckbox" checked></th>
        <th>ID</th>
        <th>Layer Name</th>
        <th>Page</th>
        <th id="newNameHeader" style="display: ${isRename ? 'table-cell' : 'none'};">New Name</th>
      `;
    }

    elements.forEach((element, index) => {
      const row = document.createElement('tr');
      const idCell = document.createElement('td');
      idCell.textContent = index;

      const isChecked = selectedElements.has(element.id);

      if (elementType === 'VARIABLE') {
        row.innerHTML = `
          <td><input type="checkbox" class="select-checkbox" ${isChecked ? 'checked' : ''} data-id="${element.id}"></td>
          <td>${index}</td>
          <td>${element.collectionName || 'N/A'}</td>
          <td>${element.modeName || 'N/A'}</td>
          <td>${element.variableName || 'N/A'}</td>
          <td>${element.variableValue || 'N/A'}</td>
        `;
      } else if (elementType === 'STYLE') {
        row.innerHTML = `
          <td><input type="checkbox" class="select-checkbox" ${isChecked ? 'checked' : ''} data-id="${element.id}"></td>
          <td>${index}</td>
          <td>${element.name}</td>
          <td>${element.styleType}</td>
        `;
      } else {
        const alphabet = String.fromCharCode(97 + (index % 26)); // cycles from a-z
        const currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
        let newNameWithVariables = newNameTemplate
          .replace('{id}', (index + 1).toString())
          .replace('{name}', element.name)
          .replace('{page}', element.pageName)
          .replace('{date}', currentDate)
          .replace('{alphabet}', alphabet);

        if (replaceText) {
          const regex = new RegExp(replaceText, 'g');
          newNameWithVariables = element.name.replace(regex, newNameWithVariables);
        }

        row.innerHTML = `
          <td><input type="checkbox" class="select-checkbox" ${isChecked ? 'checked' : ''} data-id="${element.id}"></td>
          <td>${index}</td>
          <td>${element.name}</td>
          <td>${element.pageName}</td>
          <td style="display: ${isRename ? '' : 'none'};">${newNameWithVariables}</td>
        `;
      }

      row.onclick = (event) => {
        if (event.target.tagName !== 'INPUT') {
          parent.postMessage({
            pluginMessage: {
              type: 'select-element',
              element: element
            }
          }, '*');
        }
      };

      resultsList.appendChild(row);
    });

    // Disable the execute button if there are no results
    document.getElementById('execute').disabled = elements.length === 0;

    // Add event listener to the select all checkbox
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.addEventListener('change', (event) => {
      const isChecked = event.target.checked;
      document.querySelectorAll('.select-checkbox').forEach(checkbox => {
        checkbox.checked = isChecked;
        if (isChecked) {
          selectedElements.add(checkbox.dataset.id);
        } else {
          selectedElements.delete(checkbox.dataset.id);
        }
      });
      updateSelectedCount();
    });

    // Add event listener to each row checkbox
    document.querySelectorAll('.select-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (event) => {
        const isChecked = event.target.checked;
        if (isChecked) {
          selectedElements.add(event.target.dataset.id);
        } else {
          selectedElements.delete(event.target.dataset.id);
        }
        updateSelectedCount();
        updateSelectAllCheckboxState();
      });
    });

    //select all results by default
    document.querySelectorAll('.select-checkbox').forEach(checkbox => {
      checkbox.checked = true;
      selectedElements.add(checkbox.dataset.id);
      updateSelectedCount();
    });

    updateSelectAllCheckboxState();
  };

  const updateSelectAllCheckboxState = () => {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.select-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.select-checkbox:checked');

    if (checkedCheckboxes.length === 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    } else if (checkedCheckboxes.length === checkboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    }
  };

  const blendModeOptions = `
    <option value="PASS_THROUGH">Pass through</option>
    <option value="NORMAL">Normal</option>
    <option value="DARKEN">Darken</option>
    <option value="MULTIPLY">Multiply</option>
    <option value="COLOR_BURN">Color Burn</option>
    <option value="LIGHTEN">Lighten</option>
    <option value="SCREEN">Screen</option>
    <option value="COLOR_DODGE">Color Dodge</option>
    <option value="OVERLAY">Overlay</option>
    <option value="SOFT_LIGHT">Soft Light</option>
    <option value="HARD_LIGHT">Hard Light</option>
    <option value="DIFFERENCE">Difference</option>
    <option value="EXCLUSION">Exclusion</option>
    <option value="HUE">Hue</option>
    <option value="SATURATION">Saturation</option>
    <option value="COLOR">Color</option>
    <option value="LUMINOSITY">Luminosity</option>
  `;

  const alignModeOptions = `
    <option value="CENTER">center</option>
    <option value="INSIDE">inside</option>
    <option value="OUTSIDE">outside</option>
  `;

  const horizontalTextAlignModeOptions = `
    <option value="LEFT">left</option>
    <option value="CENTER">center</option>
    <option value="RIGHT">right</option>
    <option value="JUSTIFIED">justified</option>
  `;

  const verticalTextAlignModeOptions = `
    <option value="TOP">top</option>
    <option value="CENTER">center</option>
    <option value="BOTTOM">bottom</option>
  `;

  const decorationTextModeOptions = `
    <option value="NONE">none</option>
    <option value="UNDERLINE">underline</option>
    <option value="STRIKETHROUGH">strikethrough</option>
  `;

  const positionModeOptions = `
    <option value="MIN">min</option>
    <option value="MAX">max</option>
    <option value="CENTER">center</option>
    <option value="SPACE_BETWEEN">space-between</option>
  `;

  const layoutModeOptions = `
    <option value="HORIZONTAL">horizontal</option>
    <option value="VERTICAL">vertical</option>
  `;

  const triggerOptions = `
    <option value="ON_CLICK">on click</option>
    <option value="ON_DRAG">on drag</option>
    <option value="ON_HOVER">while hovering</option>
    <option value="ON_PRESS">on press</option>  
    <option value="ON_KEY_DOWN">key/gamepad</option>
    <option value="MOUSE_ENTER">mouse enter</option>
    <option value="MOUSE_LEAVE">mouse leave</option>
    <option value="MOUSE_DOWN">mouse down</option>
    <option value="MOUSE_UP">mouse up</option>
    <option value="AFTER_TIMEOUT">after delay</option>
    <option value="ON_MEDIA_HIT">when video hits</option>
    <option value="ON_MEDIA_END">when video ends</option>
  `;

  const actionOptions = `
    <option value="NAVIGATE">navigate to</option> 
    <option value="CHANGE_TO">change to</option>
    <option value="BACK">back</option>  
    <option value="SCROLL_TO">scroll to</option>
    <option value="URL">open link</option>
    <option value="SET_VARIABLE">set variable</option>
    <option value="SET_VARIABLE_MODE">set variable mode</option>
    <option value="CONDITIONAL">conditional</option>
    <option value="OVERLAY">open overlay</option>
    <option value="SWAP">swap overlay</option>
    <option value="CLOSE">close overlay</option>
    <option value="TOGGLE_PLAY_PAUSE">toggle play/pause video</option>
    <option value="PLAY">play video</option>
    <option value="PAUSE">pause video</option>
    <option value="TOGGLE_MUTE_UNMUTE">toggle mute/unmute video</option>
    <option value="MUTE">mute video</option>
    <option value="UNMUTE">unmute video</option>
    <option value="SKIP_TO">set to specific time</option>
    <option value="SKIP_FORWARD">jump forward</option>
    <option value="SKIP_BACKWARD">jump backward</option>
  `;

  const toggleNewNameColumn = (show) => {
    const newNameHeader = document.getElementById('newNameHeader');
    const newNameCells = document.querySelectorAll('#resultsList td:nth-child(5)');
    newNameHeader.style.display = show ? 'table-cell' : 'none';
    newNameCells.forEach(cell => {
      cell.style.display = show ? 'table-cell' : 'none';
    });
  };

  document.getElementById('newName').addEventListener('input', () => {
    if (document.querySelector('input[name="action"]:checked').value === 'rename') {
      const selectedElementsOld = new Set(selectedElements);
      updateResultsList(elements);
      updateElementCount();
      const checkboxes = document.querySelectorAll('.select-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectedElementsOld.has(checkbox.dataset.id);
        if (checkbox.checked) {
          selectedElements.add(checkbox.dataset.id);
        } else {
          selectedElements.delete(checkbox.dataset.id);
        }
      }
      );
    }
    updateSelectedCount();
  });

  document.getElementById('replaceText').addEventListener('input', () => {
    if (document.querySelector('input[name="action"]:checked').value === 'rename') {
      const selectedElementsOld = new Set(selectedElements);
      updateResultsList(elements);
      updateElementCount();
      const checkboxes = document.querySelectorAll('.select-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectedElementsOld.has(checkbox.dataset.id);
        if (checkbox.checked) {
          selectedElements.add(checkbox.dataset.id);
        } else {
          selectedElements.delete(checkbox.dataset.id);
        }
      }
      );
    }
    updateSelectedCount();

  });

  const exportToCSV = () => {
    parent.postMessage({
      pluginMessage: {
        type: 'get-filename'
      }
    }, '*');
  };

  document.getElementById('csv').onclick = exportToCSV;

  const getFilters = () => Array.from(document.querySelectorAll('.filterRow')).map((row, index) => ({
      logic: index === 0 ? null : row.querySelector('.filterLogic')?.value,
      key: row.querySelector('.filterCondition').value,
      value: row.querySelector('.filterValue').value,
      comparison: row.querySelector('.filterComparison').value,
    }));

  const updateElementCount = () => {
    loadingMessage.style.display = 'block';
    parent.postMessage({
      pluginMessage: {
        type: 'filter-elements',
        objectScope: objectScope.value,
        elementType: elementType.value,
        filters: getFilters(),
        action: 'count',
      },
    }, '*');
  };

  window.onload = () => {
    const objectScope = document.getElementById('objectScope');
    const elementType = document.getElementById('elementType');
    const filterContainer = document.getElementById('filterContainer');
    const addFilter = document.getElementById('addFilter');
    const renameField = document.getElementById('newName');
    const replaceField = document.getElementById('replaceText');
    const resetButton = document.getElementById('reset');
    const csvButton = document.getElementById('csv');
    const elementCount = document.getElementById('elementCount');
    const selectButton = document.querySelector('input[name="action"][value="select"]');
    const renameButton = document.querySelector('input[name="action"][value="rename"]');
    const resultsList = document.getElementById('resultsList');
    const exportOptions = document.getElementById('exportOptions');
    const exportScale = document.getElementById('exportScale');
    const exportFormat = document.getElementById('exportFormat');
    const exportSuffix = document.getElementById('exportSuffix');
    const actionRadios = document.querySelectorAll('input[name="action"]');
    const refreshButton = document.getElementById('refresh');

    const filterConditions = [
      { group: 'General', options: ['layer-name', 'page-name', 'width', 'height', 'x', 'y', 'visibility', 'rotation', 'number-of-children', 'nested-level', 'number-of-points', 'is-locked', 'is-mask', 'export-setting', 'overriden-properties'] },
      { group: 'Appearance', options: ['appearance-rounding', 'fill', 'stroke', 'stroke-color', 'appearance-opacity', 'appearance-blendmode', 'fills-blendmode', 'fills-opacity', 'fills-visibility', 'strokes-opacity', 'strokes-blendmode', 'strokes-visibility', 'strokes-type', 'strokes-align'] },
      { group: 'Effects', options: ['effect-drop_shadow', 'effect-inner_shadow', 'effect-layer_blur', 'effect-background_blur', 'effect-drop_shadow-positionx', 'effect-drop_shadow-positiony', 'effect-drop_shadow-blur', 'effect-drop_shadow-spread', 'effect-drop_shadow-color', 'effect-drop_shadow-blendmode', 'effect-inner_shadow-positionx', 'effect-inner_shadow-positiony', 'effect-inner_shadow-blur', 'effect-inner_shadow-spread', 'effect-inner_shadow-color', 'effect-inner_shadow-blendmode'] },
      { group: 'Text', options: ['font-name', 'font-size', 'line-height', 'letter-spacing', 'font-weight', 'text-horizontal-align', 'text-vertical-align', 'text-decoration', 'paragraph-indent', 'paragraph-spacing'] },
      { group: 'Auto Layout', options: ['autolayout', 'autolayout-position', 'autolayout-direction', 'autolayout-item-spacing', 'autolayout-padding-top', 'autolayout-padding-bottom', 'autolayout-padding-left', 'autolayout-padding-right'] },
      { group: 'Interactions', options: ['interaction', 'interaction-trigger', 'interaction-action', 'flow-starting-point'] }
    ];

    const handleAction = (action) => {
      parent.postMessage({
        pluginMessage: {
          type: 'filter-elements',
          objectScope: objectScope.value,
          elementType: elementType.value,
          filters: getFilters(),
          action,
          newName: renameField.value,
          replaceText: replaceField.value,
          exportFormat: exportFormat.value,
          exportScale: exportScale.value,
          exportSuffix: exportSuffix.value,
        },
      }, '*');
    };

    const updateComparisonOptions = (condition, comparisonDropdown) => {
      let options = '';

      if (condition === "effect-drop_shadow" || condition === "effect-inner_shadow" || condition === "effect-layer_blur" || condition === "effect-background_blur" || condition === "autolayout" || condition === "export-setting" || condition === "interaction" || condition === "flow-starting-point") {
        options = `
            <option value="is-applied">is applied</option>
            <option value="is-not-applied">is not applied</option>`;
      } else if (condition === "layer-name" || condition === "page-name") {
        options = `
            <option value="equals">equals</option>
            <option value="does-not-equal">does not equal</option>
            <option value="contains">contains</option>
            <option value="does-not-contain">does not contain</option>
            <option value="fits-regex">fits regex</option>`;
      } else if (condition === "fill" || condition === "strokes-type") {
        options = `
            <option value="is-of-color">is of color</option>
            <option value="is-gradient">is gradient</option>
            <option value="is-image">is image</option>
            <option value="is-video">is video</option>`;
      } else if (condition === "stroke-color") {
        options = `
            <option value="equals">equals</option>
            <option value="does-not-equal">does not equal</option>`;
      } else if (condition === "visibility" || condition === "fills-visibility" || condition === "strokes-visibility") {
        options = `
            <option value="is-visible">is visible</option>
            <option value="is-not-visible">is hidden</option>`;
      } else if (condition === "font-name" || condition === "font-weight" || condition === "appearance-blendmode" || condition === "fills-blendmode" || condition === "strokes-blendmode" || condition === "strokes-align" || condition === "autolayout-position" || condition === "autolayout-direction" || condition === "text-horizontal-align" || condition === "text-vertical-align" || condition === "text-decoration" || condition === "interaction-trigger" || condition === "interaction-action") {
        options = `
            <option value="equals">equals</option>
            <option value="does-not-equal">does not equal</option>`;
      } else if (condition === "font-size" || condition === "line-height" || condition === "letter-spacing" || condition === "rotation" || condition === "number-of-children" || condition === "nested-level" || condition === "corner-radius-top-left" || condition === "corner-radius-top-right" || condition === "corner-radius-bottom-left" || condition === "corner-radius-bottom-right" || condition === "fills-opacity" || condition === "strokes-opacity" || condition === "autolayout-item-spacing" || condition === "autolayout-padding-top" || condition === "autolayout-padding-bottom" || condition === "autolayout-padding-left" || condition === "autolayout-padding-right" || condition === "paragraph-indent" || condition === "paragraph-spacing" || condition === "number-of-points" || condition.startsWith('effect-drop_shadow-') || condition.startsWith('effect-inner_shadow-')) {
        options = `
            <option value="equals">equals</option>
            <option value="is-larger-than">is larger than</option>
            <option value="is-smaller-than">is smaller than</option>
            <option value="does-not-equal">does not equal</option>`;
      } else if (condition === "overriden-properties" || condition === "is-locked" || condition === "is-mask") {
        options = `
            <option value="yes">yes</option>
            <option value="no">no</option>`;
      } else {
        options = `
            <option value="equals">equals</option>
            <option value="is-larger-than">is larger than</option>
            <option value="is-smaller-than">is smaller than</option>
            <option value="does-not-equal">does not equal</option>`;
      }
      comparisonDropdown.innerHTML = options;
    };

    const updateValueFieldVisibility = (condition, valueField, comparisonDropdown) => {
      const conditionsWithInput = [
        'layer-name', 'page-name', 'appearance-rounding', 'fill', 'stroke', 'stroke-color',
        'appearance-opacity', 'width', 'height', 'x', 'y', 'font-name', 'font-size', 'line-height',
        'letter-spacing', 'font-weight', 'rotation', 'number-of-children', 'nested-level', 'corner-radius-top-left',
        'corner-radius-top-right', 'corner-radius-bottom-left', 'corner-radius-bottom-right',
        'fills-opacity', 'strokes-opacity', 'autolayout-item-spacing', 'autolayout-padding-top',
        'autolayout-padding-bottom', 'autolayout-padding-left', 'autolayout-padding-right',
        'paragraph-indent', 'paragraph-spacing', 'strokes-type', 'strokes-align',
        'autolayout-position', 'autolayout-direction',
        'text-decoration', 'number-of-points', 'effect-drop_shadow-positionx', 'effect-drop_shadow-positiony', 'effect-drop_shadow-blur', 'effect-drop_shadow-spread', 'effect-drop_shadow-color', 'effect-drop_shadow-blurmode',
        'effect-inner_shadow-positionx', 'effect-inner_shadow-positiony', 'effect-inner_shadow-blur', 'effect-inner_shadow-spread', 'effect-inner_shadow-color', 'effect-inner_shadow-blurmode'
      ];
      const conditionsWithBlendmode = [
        'appearance-blendmode', 'fills-blendmode', 'strokes-blendmode', 'effect-drop_shadow-blendmode', 'effect-inner_shadow-blendmode'
      ];
      const conditionsWithAlign = [
        'strokes-align'
      ];
      const conditionsWithTextAlignHorizontal = [
        'text-horizontal-align'
      ];
      const conditionsWithTextAlignVertical = [
        'text-vertical-align'
      ];
      const conditionsWithTextDecoration = [
        'text-decoration'
      ];
      const conditionsWithLayout = [
        'autolayout-direction'
      ];
      const conditionsWithPosition = [
        'autolayout-position'
      ];
      const conditionsWithInteractionTrigger = [
        'interaction-trigger'
      ];
      const conditionsWithInteractionAction = [
        'interaction-action'
      ];
      const conditionsWithoutInput = [
        'is-gradient', 'is-image', 'is-video', 'is-visible', 'is-not-visible', 'strokes-visibility', 'fills-visibility', 'overriden-properties', 'is-locked', 'is-mask', 'interaction', 'flow-starting-point'
      ];
      valueField.style.display = conditionsWithInput.includes(condition) ? 'inline-block' : 'none';
      if (conditionsWithBlendmode.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = blendModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithAlign.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = alignModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithTextAlignHorizontal.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = horizontalTextAlignModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithTextAlignVertical.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = verticalTextAlignModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithTextDecoration.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = decorationTextModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithPosition.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = positionModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithLayout.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = layoutModeOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithInteractionTrigger.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = triggerOptions;
        valueField.replaceWith(newValueField);
      } else if (conditionsWithInteractionAction.includes(condition)) {
        const newValueField = document.createElement('select');
        newValueField.className = 'filterValue';
        newValueField.innerHTML = actionOptions;
        valueField.replaceWith(newValueField);
      } else if (condition === 'fill' && conditionsWithoutInput.includes(comparisonDropdown.value)) {
        valueField.style.display = 'none';
      } else if (['width', 'height', 'x', 'y', 'appearance-rounding', 'appearance-opacity', 'stroke', 'font-size', 'letter-spacing', 'number-of-points', 'effect-drop_shadow-positionx', 'effect-drop_shadow-positiony', 'effect-drop_shadow-blur', 'effect-drop_shadow-spread', 'effect-drop_shadow-color', 'effect-drop_shadow-blurmode', 'effect-inner_shadow-positionx', 'effect-inner_shadow-positiony', 'effect-inner_shadow-blur', 'effect-inner_shadow-spread', 'effect-inner_shadow-color', 'effect-inner_shadow-blurmode'].includes(condition)) {
        valueField.type = 'number';
        valueField.step = 'any';
        valueField.min = '-1000000';
        valueField.max = '1000000';
        valueField.addEventListener('input', restrictNumberInput);
      } else if (condition === 'layer-name' || condition === 'page-name' || condition === 'stroke-color' || condition === 'fill' || condition === 'font-name' || 'line-height') {
        valueField.type = 'text';
        valueField.removeEventListener('input', restrictNumberInput);
      } else {
        valueField.type = 'text';
      }
      valueField.dispatchEvent(new Event('change'));
    };

    const restrictNumberInput = (e) => {
      const target = e.target;
      const filterCondition = target.closest('.filterRow')?.querySelector('.filterCondition')?.value;
      if (filterCondition === 'line-height' && target.value.toLowerCase() === 'auto') {
        return;
      }
      target.value = target.value.replace(/[^0-9.-]/g, '');
      if (parseFloat(target.value) > 1000000) target.value = '1000000';
      if (parseFloat(target.value) < -1000000) target.value = '-1000000';
    };

    const adjustWindowSize = () => {
      const filterRows = document.querySelectorAll('.filterRow').length;
      const newHeight = Math.min(370 + filterRows * 55, 1100);
      parent.postMessage({ pluginMessage: { type: 'resize-window', height: newHeight } }, '*');
    };

    const createFilterRow = () => {
      const filterRow = document.createElement('div');
      filterRow.classList.add('filterRow');

      const lastFilterRow = filterContainer.lastElementChild;
      const lastCondition = lastFilterRow ? lastFilterRow.querySelector('.filterCondition').value : '';
      const lastComparison = lastFilterRow ? lastFilterRow.querySelector('.filterComparison').value : '';
      const lastValue = lastFilterRow ? lastFilterRow.querySelector('.filterValue').value : '';

      filterRow.innerHTML = `
        ${filterContainer.children.length === 0 ? '<p>such that the            </p>' : `
          <label>
            <select class="filterLogic">
              <option value="AND">and</option>
              <option value="OR">or</option>
            </select>
          </label>
        `}
        <label>
          <select class="filterCondition">
            ${filterConditions.map(group => `
              <optgroup label="${group.group}">
                ${group.options.map(cond => `<option value="${cond}" ${cond === lastCondition ? 'selected' : ''}>${cond}</option>`).join('')}
              </optgroup>
            `).join('')}
          </select>
        </label>
        <select class="filterComparison"></select>
        <label>
          <input type="text" class="filterValue" placeholder="value" value="${lastValue}" />
        </label>
        <button class="removeFilter">-</button>
      `;

      const conditionDropdown = filterRow.querySelector('.filterCondition');
      const comparisonDropdown = filterRow.querySelector('.filterComparison');
      const valueField = filterRow.querySelector('.filterValue');

      updateComparisonOptions(conditionDropdown.value, comparisonDropdown);
      comparisonDropdown.value = lastComparison || comparisonDropdown.options[0].value;
      updateValueFieldVisibility(conditionDropdown.value, valueField, comparisonDropdown);

      conditionDropdown.addEventListener('change', () => {
        updateComparisonOptions(conditionDropdown.value, comparisonDropdown);
        updateValueFieldVisibility(conditionDropdown.value, valueField, comparisonDropdown);
        updateElementCount();
      });

      comparisonDropdown.addEventListener('change', () => {
        updateValueFieldVisibility(conditionDropdown.value, valueField, comparisonDropdown);
        updateElementCount();
      });

      filterRow.querySelector('.removeFilter').onclick = () => {
        filterRow.remove();
        updateElementCount();
        adjustWindowSize();
      };

      filterContainer.appendChild(filterRow);
      updateElementCount();
      adjustWindowSize();
    };

    elementType.onchange = updateElementCount;
    objectScope.onchange = () => {
      updateElementCount();
      if (objectScope.value === 'all-pages') {
        selectButton.nextSibling.textContent = ' Select (on this page)';
      } else {
        selectButton.nextSibling.textContent = ' Select';
      }
    };
    filterContainer.addEventListener('input', () => {
      updateElementCount();
      adjustWindowSize();
    });

    const observer = new MutationObserver(() => {
      adjustWindowSize();
    });

    observer.observe(filterContainer, { childList: true });

    addFilter.onclick = createFilterRow;
    document.getElementById('execute').onclick = () => {
      const selectedAction = document.querySelector('input[name="action"]:checked').value;
      const selectedElements = Array.from(document.querySelectorAll('.select-checkbox:checked')).map(checkbox => checkbox.dataset.id);
      parent.postMessage({
        pluginMessage: {
          type: 'filter-elements',
          objectScope: objectScope.value,
          elementType: elementType.value,
          filters: getFilters(),
          action: selectedAction,
          newName: renameField.value,
          replaceText: replaceField.value,
          exportFormat: exportFormat.value,
          exportScale: exportScale.value,
          exportSuffix: exportSuffix.value,
          selectedElements
        },
      }, '*');
    };

    document.querySelectorAll('input[name="action"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const isRename = document.querySelector('input[name="action"]:checked').value === 'rename';
        const isExport = radio.value === 'export';
        renameField.style.display = isRename ? 'inline-block' : 'none';
        replaceField.style.display = isRename ? 'inline-block' : 'none';
        exportOptions.style.display = isExport ? 'inline-block' : 'none';
        toggleNewNameColumn(isRename);
      });
    });

    resetButton.onclick = () => {
      objectScope.value = 'current-page';
      elementType.value = 'ANY';
      filterContainer.innerHTML = '';
      document.getElementById('newName').value = '';
      document.getElementById('replaceText').value = '';
      exportScale.value = 'default';
      exportFormat.value = 'default';
      exportSuffix.value = 'default';
      actionRadios.forEach(radio => {
        if (radio.value === 'select') {
          radio.checked = true;
        } else {
          radio.checked = false;
        }
      });
      renameField.style.display = 'none';
      replaceField.style.display = 'none';
      exportOptions.style.display = 'none';
      parent.postMessage({ pluginMessage: { type: 'initialize-count' } }, '*');
    };

    refreshButton.onclick = updateElementCount;

    // Initialize the results list when the plugin opens
    parent.postMessage({ pluginMessage: { type: 'initialize-count' } }, '*');
  };

  window.onmessage = (event) => {
    const { type, filterConditions: conditions, count, elements: newElements, image, name, url, currentPageCount, fileName, isLoading } = event.data.pluginMessage;
    elements = newElements || [];
    const selectButton = document.querySelector('input[name="action"][value="select"]');
    if (type === 'loading') {
      const loadingMessage = document.getElementById('loadingMessage');
      loadingMessage.style.display = isLoading ? 'block' : 'none';
    } else if (type === 'update-results') {
      updateElementCount();
    } else if (type === 'filter-options') {
      filterConditions = conditions;
      document.querySelectorAll('.filterCondition').forEach(dropdown => {
        dropdown.innerHTML = conditions.map(cond => `<option value="${cond}">${cond}</option>`).join('');
      });
    } else if (type === 'update-element-count') {
      if (count === 1) {
        elementCount.textContent = `${count} element found`;
      } else {
        elementCount.textContent = `${count} elements found`;
      }
      if (objectScope.value === 'all-pages') {
        selectButton.nextSibling.textContent = ` Select (on this page)`;
      }
      updateResultsList(elements);
    } else if (type === 'download-file') {
      const link = document.createElement('a');
      link.href = url;
      link.download = name;
      link.click();
      URL.revokeObjectURL(url);
    } else if (type === 'filename') {
      const rows = [];
      const headers = Array.from(document.querySelectorAll('#resultsTable thead th')).map(th => th.textContent.trim()).slice(1);
      headers[headers.length - 1] = 'File'; // Replace the last header with filename
      rows.push(headers.join(','));

      const dataRows = Array.from(document.querySelectorAll('#resultsTable tbody tr'));
      dataRows.forEach(row => {
        const checkbox = row.querySelector('.select-checkbox');
        if (checkbox && checkbox.checked) {
          const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim()).slice(1);
          const elementId = checkbox.dataset.id;
          cells[cells.length - 1] = fileName; // Replace the last cell with the file name
          rows.push(cells.join(','));
        }
      });

      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'results.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };
  
  parent.postMessage({ pluginMessage: { type: 'resize-window', height: 370 } }, '*');

  const updateSelectedCount = () => {
    const selectedCount = document.querySelectorAll('.select-checkbox:checked').length;
    const totalCount = document.querySelectorAll('.select-checkbox').length;
    if (totalCount === 1) {
      elementCount.textContent = `${totalCount} element found (${selectedCount} chosen for processing)`;
    } else {
      elementCount.textContent = `${totalCount} elements found (${selectedCount} chosen for processing)`;
    }
    document.getElementById('execute').disabled = selectedCount === 0;
  };
</script>